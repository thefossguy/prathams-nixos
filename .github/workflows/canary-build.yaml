name: Canary Build
on:
  push:
    branches: [ "master" ]
  schedule:
    - cron: '30 18 * * *' # Everyday, at 00:00 IST


jobs:
  canary-build:
    name: Build NixOS Systems
    runs-on: ubuntu-latest
    permissions:
      id-token: "write"
      contents: "read"
    steps:
      - uses: actions/checkout@main

      - name: Setting up QEMU User Emulation
        run: |
          sudo apt-get update
          sudo apt-get install --yes binfmt-support qemu-user-static

      - name: Removing unnecessary registered binfmts
        run: |
          for registeredBinfmt in /proc/sys/fs/binfmt_misc/qemu-*; do
              sudo update-binfmts --disable "$(basename "${registeredBinfmt}")"
          done

      - name: Enable NixOS-like QEMU binfmt registrations
        run: |
          rm -vf ./scripts/nix-ci/binfmts/"$(uname -m)-linux"
          sudo cp -v scripts/nix-ci/binfmts/*-linux /usr/share/binfmts/
          for nixosStyleBinfmt in /usr/share/binfmts/*-linux; do
              sudo update-binfmts --enable "$(basename "${nixosStyleBinfmt}")"
          done
          ls -alh /proc/sys/fs/binfmt_misc/

      - uses: DeterminateSystems/nix-installer-action@main
        with:
          extra-conf: "extra-platforms = aarch64-linux riscv64-linux"

      - uses: DeterminateSystems/magic-nix-cache-action@main

      # Remove the `cachix` after my fork with `16k-kernel` is no longer necessary
      - uses: cachix/cachix-action@master
        with:
          name: thefossguy

      - name: Running CI
        run: |
          nix flake update
          python3 ./scripts/nix-ci/builder.py --use-emulation --nixosConfigurations --homeConfigurations --devShells --packages

      - name: Look at results
        run: |
          ls -alh ./result*
