name: Build canary
on:
  workflow_dispatch:
  schedule:
    - cron: '30 18 * * *' # Everyday, at 00:00 IST
  push:
    branches: [ "master" ]


jobs:

  build-nixos:
    name: Build NixOS Systems
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest]
        architecture: [x64, arm64]
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@main
      - uses: DeterminateSystems/nix-installer-action@main
      - uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Starting build
        run: |
          nix flake update
          ./scripts/nix-ci/builder.py --nixosConfigurations

  build-homes:
    name: Build standalone home-manager configurations
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest]
        architecture: [x64, arm64]
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@main
      - uses: DeterminateSystems/nix-installer-action@main
      - uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Starting build
        run: |
          nix flake update
          ./scripts/nix-ci/builder.py --homeConfigurations

  build-packages:
    name: Build packages
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest]
        architecture: [x64, arm64]
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@main
      - uses: DeterminateSystems/nix-installer-action@main
      - uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Starting build
        run: |
          nix flake update
          ./scripts/nix-ci/builder.py --packages

  build-devshells:
    name: Build devshells
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest]
        architecture: [x64, arm64]
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@main
      - uses: DeterminateSystems/nix-installer-action@main
      - uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Starting build
        run: |
          nix flake update
          ./scripts/nix-ci/builder.py --devShells

  build-isos:
    name: Build NixOS ISOs
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest]
        architecture: [x64, arm64]
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@main
      - uses: DeterminateSystems/nix-installer-action@main
      - uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Starting build
        run: |
          nix flake update
          ./scripts/nix-ci/builder.py --isoImages
